{% extends 'storage/target_base.html' %}

{% block object_detail %}

<table class="table table-striped table-condensed">
    <tr>
        <td>
            <button class="btn btn-primary btn-large">
                <span class="label-caps">
                    <small>{{ object.type }}</small>
                </span>
            </button>
        </td>
    </tr>
    {# TODO Put the dataset info in an SSI template, use same for filesystem/volume #}
</table>

<p>

<table class="table table-striped table-condensed">
    <caption>
        Target LUN Mapping:
    </caption>
    <thead>
        <tr>
            <th>tpg</th>
            <th>lun</th>
            <th>backstore</th>
            <th>fabric</th>
            <th>tasks</th>
        </tr>
    </thead>
    <tbody>
        {% for tpg in object.tpgs %}
        {% for lun in tpg.luns %}
        <tr>
            <td>
                tpg{{ tpg.tag }}
                {% if tpg.enable == 0 %}
                    <button class="btn btn-mini btn-inverse tpg-toggle" data-url="{% url target-pg-update slug=object.wwn tag=tpg.tag %}" data-enable="1">Off</button>
                {% else %}
                    <button class="btn btn-mini btn-success tpg-toggle" data-url="{% url target-pg-update slug=object.wwn tag=tpg.tag %}" data-enable="0">On</button>
                {% endif %}
            </td>
            <td>
                lun{{ lun.lun }}
            </td>
            <td>
                {% with lun.storage_object.get_volume as lun_volume %}
                <a href="{{ lun_volume.get_absolute_url }}">
                    {{ lun_volume.name }}
                </a>
                {% endwith %}
            </td>
            <td>
                <span class="label-caps">{{ object.fabric_module.name }}</span>
            </td>
            <td>
                <button class="btn btn-mini btn-danger">x</button>
            </td>
        </tr>
        {% endfor %}
        {% endfor %}
    </tbody>
</table>

</p>

<div>
    <a href="#" class="target-lun-mapping-create">
        <span class="label label-info" style="text-align: right;">
            add lun mapping
        </span>
    </a>
</div>
<br />



{% comment %}
<div>
    <a href="#add-lun-mapping-modal" data-toggle="modal">
        <span class="label label-info" style="text-align: right;">
            add lun mapping
        </span>
    </a>
</div>
<br />

<div class="modal fade hide" id="add-lun-mapping-modal">
    <div class="modal-header">
        <legend>
            Add LUN Mapping
        </legend>
        <button type="button" class="close" data-dismiss="modal">
            <i class="icon-close"></i>
        </button>

    </div>
    <div class="modal-body">
        meh
    </div>
    <div class="modal-footer">
        <a href="#" data-dismiss="modal"><button class="btn">Close</button></a>
    </div>
</div>

<div class="modal fade hide" id="add-lun-mapping-modal2">
    <form class="form-horizontal" method="POST">{% csrf_token %}
        <fieldset>
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">
                    <i class="icon-close"></i>
                </button>
                <legend>
                    Add LUN Mapping
                </legend>
            </div>
            <div class="modal-body">
                <div class="control-group">
                    <label class="control-label" for="name">Volume</label>
                    <div class="controls">
                        <input type="hidden" name="target_wwn" value="{{ object.wwn }}"/>

                        <select data-placeholder="volume" class="chosen-select">
                            {% for v in volumes %}
                            <option value="{{ v.name }}">{{ v.name }}</option>
                            {% endfor %}
                        </select><br />
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="name">TPG</label>
                    <div class="controls">
                        <select data-placeholder="tpg" class="chosen-select">
                            {% for tpg in object.tpgs %}
                            <option value="{{ tpg.tag }}">{{ tpg.tag }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </fieldset>
        <div class="modal-footer">
            <a href="#" data-dismiss="modal"><button class="btn">Close</button></a>
            <button type="submit" class="btn btn-primary btn-submit">Add</button>
        </div>
    </form>
</div>

<div class="modal fade hide" id="add-target-modal">
    <form class="form-horizontal">
        <fieldset>
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">
                    Ã—
                </button>
                <legend>
                    Add new target
                </legend>
            </div>
            <div class="modal-body">
                <div class="control-group">
                    <label class="control-label" for="name">Name</label>
                    <div class="controls">
                        <input type="text" class="input-xlarge" id="name">
                        <p class="help-block">
                            Allowed characters: [A-z0-9_/-]
                        </p>
                    </div>
                </div>
            </div>
        </fieldset>
    </form>
    <div class="modal-footer">
        <a href="#" class="btn" data-dismiss="modal">Close</a>
        <a href="#" class="btn btn-primary">Add</a>
    </div>
</div>
{% endcomment %}

{% if debug %}
<blockquote>
<pre>
{{ object.type|capfirst }}: {{ object.dumps|pprint }}
</pre>
</blockquote>
{% endif %}


{% load crispy_forms_tags %}

<div class="hide">
    <div id="target-remove-form-container">
        {% crispy target_remove_form %}
    </div>
    <div id="target-pg-volume-lun-map-form-container">
        {% crispy target_pg_volume_lun_map_form %}
    </div>
</div>

<script>

$('.chosen-select').chosen();

function tpg_toggle(event) {
    var self = this;
    var url = $(this).data('url');
    var data = {enable: $(this).data('enable')};

    // send form data
    //$.post("test.php", $("#testform").serialize());

    console.log(data);
    $.post(url, data,
        function(data) {
            console.log(data);
            enable = data['enable'];
            if (enable == 1)
                $(self).html("On").addClass('btn-success').removeClass('btn-inverse').data("enable", 0);
            else
                $(self).html("Off").removeClass('btn-success').addClass('btn-inverse').data("enable", 1);;
        }, "json");
}

$('.tpg-toggle').on('click', tpg_toggle);

$('a.target-remove').popover({
    title: 'Create Lun Mapping',
    placement: 'bottom',
    content: $("#target-remove-form-container").html(), });

$('a.target-lun-mapping-create').popover({
    title: 'Create Lun Mapping',
    placement: 'right',
    content: $("#target-pg-volume-lun-map-form-container").html(), });


</script>

{% endblock %}
