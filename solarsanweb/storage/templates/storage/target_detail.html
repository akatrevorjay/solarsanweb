{% extends 'storage/target_base.html' %}

{% load url from future %}
{% load crispy_forms_tags %}
{% load to_list %}

{% block object_detail_container %}
<!-- Target Detail Container -->
<div class="row">
    <!--<div id="object-detail-content" class="well">-->
    <div id="object-detail-content">


{% block object_detail %}

<div class="row" style="margin-left: 0px;">
    <!--<div class="well">-->
    <!--<div>-->

<div class="tabbable tabs-left"> <!-- Only required for left/right tabs -->
  <ul class="nav nav-tabs">
    {% for tpg in object.tpgs reversed %}
    <li class="{% if forloop.first %}active{% endif %}">
        <a href="#tabs-tpgs-{{ tpg.tag }}" data-toggle="tab">
            <div class="btn-group">
                <button class="btn btn-mini">
                    portal group {{ tpg.tag }}
                </button>
                <button class="btn btn-mini {% if tpg.enable == 0 %}btn-inverse{% else %}btn-success{% endif %} tpg-toggle"
                    data-url="{% url 'target-pg-update' slug=object.wwn tag=tpg.tag %}"
                    data-enable="{% if tpg.enable == 0 %}1{% else %}0{% endif %}">
                    {% if tpg.enable == 0 %}off{% else %}on{% endif %}
                </button>
            </div>
        </a>
    </li>
    {% endfor %}
  </ul>

  <div class="tab-content">


<!--<div class="accordion" id="accordion-tpgs">-->



{% for tpg in object.tpgs reversed %}
{% with luns=tpg.luns|to_list %}


    <div class="tab-pane{% if forloop.first %} active{% endif %}" id="tabs-tpgs-{{ tpg.tag }}">

{% comment %}
  <div class="accordion-group">                                                                                                
    <div class="accordion-heading">                                                                                            
      <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion-tpgs" href="#collapse-tpgs-{{ tpg.tag }}">    
                <div class="btn-group">                                                                                        
                    <button class="btn btn-mini">                                                                              
                        portal group {{ tpg.tag }}                                                                             
                    </button>                                                                                                  
                    <button class="btn btn-mini {% if tpg.enable == 0 %}btn-inverse{% else %}btn-success{% endif %} tpg-toggle"
                        data-url="{% url 'target-pg-update' slug=object.wwn tag=tpg.tag %}"                                    
                        data-enable="{% if tpg.enable == 0 %}1{% else %}0{% endif %}">                                         
                        {% if tpg.enable == 0 %}off{% else %}on{% endif %}                                                     
                    </button>                                                                                                  
                </div>                                                                                                         

      </a>                                                                                                                     
    </div>                                                                                                                     

    <div id="collapse-tpgs-{{ tpg.tag }}" class="accordion-body collapse{% if forloop.first %} in{% endif %}">                 
      <div class="accordion-inner">                                                                                            
{% endcomment %}

<table class="table table-striped no-vertical-padding">
    {% comment %}
    <thead>
        <tr>
            <th>tpg</th>
            <th></th>
        </tr>
    </thead>
    {% endcomment %}
    <tbody>
        <tr>
            <!--<td rowspan="{{ luns|length }}">-->
            <td>
                <div class="btn-group">
                    <button class="btn btn-mini">
                        portal group {{ tpg.tag }}
                    </button>
                    <button class="btn btn-mini {% if tpg.enable == 0 %}btn-inverse{% else %}btn-success{% endif %} tpg-toggle"
                        data-url="{% url 'target-pg-update' slug=object.wwn tag=tpg.tag %}"
                        data-enable="{% if tpg.enable == 0 %}1{% else %}0{% endif %}">
                        {% if tpg.enable == 0 %}off{% else %}on{% endif %}
                    </button>
                </div>
            </td>
        </tr>
        <tr>
            <td>

<!-- Tpg Luns -->
<blockquote>
<table class="table table-striped no-vertical-padding">
    <!--<caption>              -->
    <!--    Target LUN Mapping:-->
    <!--</caption>             -->
    <thead>
        <tr>
            <th>lun</th>
            <th>backstore</th>
            <th></th>
            <th style="text-align: right;">tasks</th>
        </tr>
    </thead>
    <tbody>
        {% for lun in luns %}
        <tr>
            <td>
                lun{{ lun.lun }}
            </td>

            <td width="60%" colspan="2">
                {% with lun.storage_object.get_volume as lun_volume %}
                <a href="{{ lun_volume.get_absolute_url }}">
                    {{ lun_volume.name }}
                </a>
                {% endwith %}
            </td>

            <td style="text-align: right;">
                <button class="btn btn-mini btn-danger">del</button>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="4">
                <span class="muted"><i>(none)</i></span>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</blockquote>

<!-- Tpg Portals -->
<blockquote>
<table class="table table-striped no-vertical-padding">
    <thead>
        <tr>
            <th>portal ip:port</th>
            <th>dump</th>
            <th></th>
            <th style="text-align: right;">tasks</th>
        </tr>
    </thead>
    <tbody>
        {% for portal in tpg.network_portals|to_list %}
        <tr>
            <td>
                {{ portal.ip_address }}:{{ portal.port }}
            </td>

            <td colspan="2">
                {{ portal.dump }}
            </td>

            <td style="text-align: right;">
                <button class="btn btn-mini btn-danger">del</button>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="4">
                <span class="muted"><i>(none)</i></span>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</blockquote>

<!-- Tpg ACLs -->
<blockquote>
<table class="table table-striped no-vertical-padding">
    <thead>
        <tr>
            <th>node wwn</th>
            <th>dump</th>
            <th></th>
            <th style="text-align: right;">tasks</th>
        </tr>
    </thead>
    <tbody>
        {% for acl in tpg.node_acls|to_list %}
        <tr>
            <td>
                {{ acl.node_wwn }}
            </td>

            <td colspan="2">
                {{ acl.dump|pprint }}
            </td>

            <td style="text-align: right;">
                <button class="btn btn-mini btn-danger">del</button>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="4">
                <span class="muted"><i>(none)</i></span>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</blockquote>

            </td>
        </tr>

        <tr>
            <td>
                <a href="#">
                    <span class="label label-info" style="text-align: right;">
                        add acl
                    </span>
                </a>&nbsp;

                <a href="#">
                    <span class="label label-info" style="text-align: right;">
                        add portal
                    </span>
                </a>&nbsp;

                <a href="#" class="target-lun-mapping-create">
                    <span class="label label-info" style="text-align: right;">
                        add lun
                    </span>
                </a>&nbsp;
            </td>
        </tr>

    </tbody>
</table>

{% comment %}
      </div>
    </div>
  </div>
{% endcomment %}


<!--</div>-->


  </div>

{% endwith %}
{% endfor %}

</div>

  </div>
</div>



<!--<script>                   -->
<!--$(".accordion").collapse();-->
<!--</script>                  -->


<br />
<div>
    <a href="{% url 'target-pg-create' slug=object.wwn %}" data-target="#myModal" data-toggle="modal">
        <span class="label label-info" style="text-align: right;">
            add tpg
        </span>
    </a>&nbsp;

</div>
<br />
<br />

<!-- Modal -->
<div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">Modal Test Header</h3>
  </div>
  <div class="modal-body">
    <p>One fine body…</p>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    <button class="btn btn-primary">Save changes</button>
  </div>
</div>


{% if debug %}
<blockquote>
<pre>
-- Target Obj
{{ object.dumps|pprint }}

-- TPG Obj
{% for tpg in rtslib_tpgs %}
{{ tpg.dump|pprint }}
{% endfor %}

-- LUN Obj
{% for lun in rtslib_luns %}
{{ lun.dump|pprint }}
{% endfor %}

-- Session Obj
{% for session in rtslib_sessions %}
{{ session.dump|pprint }}
{% endfor %}

-- Node ACL Objs
{% for nacl in rtslib_node_acls %}
{{ nacl|pprint }}
{% endfor %}

-- Fabric Objs
{% for fm in rtslib_fabric_modules %}
{{ fm|pprint }}
{% endfor %}

-- JSON Config
{{ rtslib_config_dump|pprint }}
</pre>
</blockquote>
{% endif %}


<div class="hide">
    <div id="target-remove-form-container">
        {% crispy target_remove_form %}
    </div>
    <div id="target-pg-volume-lun-map-form-container">
        {% crispy target_pg_volume_lun_map_form %}
    </div>
</div>

<script>

$('.chosen-select').chosen();

function tpg_toggle(event) {
    var self = this;
    var url = $(this).data('url');
    var data = {enable: $(this).data('enable')};

    // send form data
    //$.post("test.php", $("#testform").serialize());

    console.log(data);
    $.post(url, data,
        function(data) {
            console.log(data);
            enable = data['enable'];
            if (enable == 1)
                $(self).html("on").addClass('btn-success').removeClass('btn-inverse').data("enable", 0);
            else
                $(self).html("off").removeClass('btn-success').addClass('btn-inverse').data("enable", 1);;
        }, "json");
}

$('.tpg-toggle').on('click', tpg_toggle);

$('a.target-remove').popover({
    title: 'Create Lun Mapping',
    placement: 'bottom',
    content: $("#target-remove-form-container").html(), });

$('a.target-lun-mapping-create').popover({
    title: 'Create Lun Mapping',
    placement: 'right',
    content: $("#target-pg-volume-lun-map-form-container").html(), });


</script>

{% endblock %}

    </div>
</div>



{% endblock %}


