{% extends "solarsan/base_site.html" %}
{% load i18n %}

{% load dajaxice_templatetags %}

{% block extrastyle %}{{ block.super }}<link rel="stylesheet" type="text/css" href="{% load adminmedia %}{% admin_media_prefix %}css/dashboard.css" />{% endblock %}

{% block extrahead %}
	<script type="text/javascript" src="{{ STATIC_URL }}js/jquery.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}flot/jquery.flot.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}flot/jquery.flot.pie.resize_update.js"></script>

	{% dajaxice_js_import %}
	<script type="text/javascript" src="{{ STATIC_URL }}js/jquery.dajax.core.js" charset="utf-8"></script>
{% endblock %}

{% block coltype %}colMS{% endblock %}

{% block bodyclass %}dashboard{% endblock %}

{% block breadcrumbs %}{% endblock %}

{% block content %}
<div id="content-main">

{% block graph_js %}
<script type="text/javascript">

var graphs = {};

$(function () {
    function MergeJSON (o, ob) {
        for (var z in ob) {
           o[z] = ob[z];
        }
        return o;
    }

    function graph_update_ajax_callback(graph, timeout, series) {
        console.log("graph_update_ajax_callback: "+graph);
        var graph_plot = graphs[graph];
        
        if ($("#"+graph).hasClass("ajax_graph_donut")) {
            graph_plot.setData(series);            
        } else if ($("#"+graph).hasClass("ajax_graph_line")) {
            for (var z in series) {
                data[]
            }
            graph_plot.setData(MergeJSON(graph_plot.getData(), series));
        }

        graph_plot.setupGrid();
        graph_plot.draw();
        //graph_plot.triggerRedrawOverlay();

        delete graph_plot

        if (timeout) {
            setTimeout(function() { graph_update_ajax(graph, timeout); }, timeout);
        }
    }

    function graph_update_ajax(graph, timeout) {
        //console.log("graph_update_ajax: "+graph);
        $.ajax({
            type: "GET",
            url: "{% url solarsan.views.graph_stats %}",
            data: "graph="+graph,
            dataType: 'json',
            success: function(ret) { graph_update_ajax_callback(graph, timeout, ret); }
        });
    }

    function graph_donut_hover(event, pos, obj) {
        if (!obj)
            return;
        percent = parsefloat(obj.series.percent).toFixed(2);
        $("#hover").html('<span style="font-weight: bold; color: '+obj.series.color+'">'+obj.series.label+' ('+percent+'%)</span>');
    }

    $(".ajax_graph_donut").each( function() {
        graphs[$(this).attr("id")] = $.plot($(this), [], {
            series: {
                pie: {
                    innerRadius: 0.5,
                    show: true
                }
            },
            grid: {
                hoverable: true,
                clickable: true
            }
        });
        $(this).bind("plothover", graph_donut_hover);
        //$(this).bind("plotclick", graph_donut_click);
    });
    
    $(".ajax_graph_line").each( function() {
        graphs[$(this).attr("id")] = $.plot($(this),[], {
            lines: { show: true },
            points: { show: true },
            xaxis: { tickDecimals: 0, tickSize: 1 }
        });
    });
    
    $(".ajax_graph").each( function() {
        graph_update_ajax($(this).attr("id"), 5000);
    });
});

</script>
{% endblock %}

{% block graphs %}
<div id="graph_utilization" class="ajax_graph_donut ajax_graph" style="width: 600px; height: 200px;"></div><br />
<br />
<div id="graph_iops" class="ajax_graph_line ajax_graph" style="width: 600px; height: 200px;"></div><br />
<br />
<div id="graph_throughput" class="ajax_graph_line ajax_graph"  style="width: 600px; height: 200px;"></div><br />
{% endblock %}


{% if app_list %}
    {% for app in app_list %}
        <div class="module">
        <table summary="{% blocktrans with app.name as name %}Models available in the {{ name }} application.{% endblocktrans %}">
        <caption><a href="{{ app.app_url }}" class="section">{% blocktrans with app.name as name %}{{ name }}{% endblocktrans %}</a></caption>
        {% for model in app.models %}
            <tr>
            {% if model.perms.change %}
                <th scope="row"><a href="{{ model.admin_url }}">{{ model.name }}</a></th>
            {% else %}
                <th scope="row">{{ model.name }}</th>
            {% endif %}

            {% if model.perms.add %}
                <td><a href="{{ model.admin_url }}add/" class="addlink">{% trans 'Add' %}</a></td>
            {% else %}
                <td>&nbsp;</td>
            {% endif %}

            {% if model.perms.change %}
                <td><a href="{{ model.admin_url }}" class="changelink">{% trans 'Change' %}</a></td>
            {% else %}
                <td>&nbsp;</td>
            {% endif %}
            </tr>
        {% endfor %}
        </table>
        </div>
    {% endfor %}
{% else %}
    <p>{% trans "You don't have permission to edit anything." %}</p>
{% endif %}
</div>
{% endblock %}


